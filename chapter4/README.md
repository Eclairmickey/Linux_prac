# 4章 プロセススケジューラ

Linuxカーネルはプロセスを同時に実行しているように見せかけることを普段行っている。これは1つのCPU上で1つのプロセスしか動かせないためである。
クアッドコアやデュアルコアといったマルチコアCPUは1つのコアを1つのPCUと認識させることで複数プロセスを実行することを可能としている。

# sched.c
・論理CPU上で複数プロセスを動かしそれらの進捗を確認することを行う  
・loops_per_msec()によって1秒あたりの計算量を見積もっている。  
・1core-n process.txt(n=1,2,4)についてx軸を経過時間(ms),y軸をプロセス番号(2つ目)とすると、そのタイミングでどのプロセスが動作しているかを確認できる。  
・1core-n process.txt(n=1,2,4)についてx軸を経過時間(ms),y軸をプロセスの進捗(3つ目)とすると、そのタイミングでそのプロセスが任意の時間にどれだけの進捗であるかが確認できる。  

## コンテキストスイッチ
論理CPU上で実行するプロセスを切り替えることをいう。タイムスライスによって次のプロセスに移る際に発生する。

# プロセスの状態遷移
プロセスは生成されてから「実行待ち状態」となる。そして、「実行待ち状態」のプロセスはCPU実行権を得た時に「実行状態」となる。実行中のプロセスはCPU実行権を失い「実行待ち状態」となるかイベント待ちのために「スリープ状態」となる。このように実行中は実行待ち状態、実行状態、スリープ状態を行き来する。
実行し終わったプロセスは、ゾンビ状態となって終了となる。

## sched.cにおける状態遷移
・プロセスが1つの場合  
基本的には実行中のプロセスp0が実行中であるため論理CPUを専有する。

プロセスが1つの場合でも実行途中でスリープ状態となる場合には、スリープ状態のときのみ論理CPUを専有しない。このとき論理CPUはアイドルプロセスという何もしないプロセスを動作している。

・プロセスが2つの場合  
実行状態のp0と実行可能状態のp1が最初に存在しており、これらがタイムスライスごとに状態が入れ替わる。

# スループット,レイテンシ
スループットとレイテンシはトレードオフの関係にある。

## スループット
単位時間あたりにした仕事量。つまり、CPUのアイドル状態の時間が少ないほど良いということがある。  
論理CPUのアイドル状態を減らした際にはスループットは減るが、アイドル状態とならない状況ではスループットは変わらない。

## レイテンシ
プロセスの処理開始から処理終了までの時間。  
当然ながらプロセスを増やすほどレイテンシは増える。しかし平均レイテンシは変わらない。  

ラウンドロビン方式でプロセスをスケジュールしなかった場合、複数プロセスを同時に動かしても各レイテンシが増えていく形と成る。これは１つ目のプロセスが終了するまで2つ目のプロセスは待機状態となるためである。  
(例:プロセス1がlat1秒の時、プロセス2の終了時間がlat1+lat2、プロセス3はlat1+lat2+lat3と増えてしまう)


# 経過時間と使用時間について
経過時間はプロセスが開始してから終了するまでの時間のことを指す、使用時間は論理CPUが実行状態となっている時間を示す。  
以下は、論理CPU1つでプロセス数1つのときの経過時間と使用時間を取得した例である。  

```
time taskset -c 0 ./sched 1 10000 10000
estimating workout witch takes just one milisecond
end estimation
0	 11480	 100

real	0m13.509s
user	0m13.476s
sys	0m0.000s
```

# nice()
システムコールnice()は特定のプロセスに実行の優先度を付与することが出来る。優先度は-19〜20があり、-19が一番優先度が高く20が一番低くなる。優先度が高いほうが多くのCPU時間を得ることが出来る。