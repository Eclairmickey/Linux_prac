# 5章 メモリ管理
# Out of Memory
メモリ管理システムはカーネル内の空きメモリが少なくなると、メモリを開放するといったことを行う。しかし、その後もメモリの使用量が増え続けると、システムがメモリ不足により何もできなくなる状態「Out of Momory」となる。この時、適当なプロセスをkillすることによってメモリを開放する「OOM killer」という異能がある。これは何も設定を行っていない時にはどのプロセスがkillされるかは当然わからない。vm.panic_on_oomのパラメータを0から1に変更することでサーバにおいてはOOM発生時にシステムを強制終了させるよう指定することが出来る。

# メモリ割り当て
カーネルがプロセスにメモリを割り当てるときは大きく以下の2つのパターンがある。  
・プロセス生成時→(chapter3)  
・生成済みのプロセスに追加で動的にプロセスを割り当てる時。  

単純なメモリの管理だと以下のような問題が起きてしまう
・メモリが100バイトずつ3箇所のとびとびな場所にある場合でも300バイトの確保は出来ない  
・カーネルや他のプロセスが利用しているメモリ領域にアクセスが可能であるため、システムを破壊しかねない  
・マルチプロセスで扱う際プログラム、データが指定された番地でしか動作できないために並列動作が出来ないことがある。  

このような問題を解決するために仮想記憶が存在する。

# 仮想記憶
直接物理メモリにアクセスした際に起きていた問題が、仮想記憶を用いると問題が消える。単純な仕組みとしては仮想アドレス上の100番地にアクセスしようとすると物理メモリのアドレス600に存在するデータを指定するようにする仕組み。  
ページテーブルという仮想アドレスと物理アドレスを関連付けた表が管理を行っている。しかし、この表に含まれていない領域を指定してしまった時には「ページフォールト」という割り込みが発生する。基本的は「ページフォールトハンドラ」によって不正アクセスかどうかを検知してプロセスへ通知を出し、通知を受けたプロセスは強制終了するようになっている。  
以下のように不正なアクセスを行うとSIGSEGVシグナルが裏で発生して、強制終了する。
```
$ cc -o segv segv.c
$ ./segv 
before invalid access
Segmentation fault (コアダンプ)
```

## mmap()とmalloc()
C言語でのメモリを確保するための関数であるmalloc()は内部的にmmap()を呼び出すことによってメモリの確保を行っている。
しかし、mmap()はページごとにメモリを確保するためバイト単位でメモリを確保するmalloc()の挙動を実現するためには少し不十分である。そこで、glibcは事前にmmap()によってカーネルから大きなメモリを確保した上で、malloc()が発行された時にその領域から必要な分をバイト単位で切り出してプログラムを返すようにしている。また、この時にmmap()が確保した領域が足りなかった際には再びmmap()によって領域を確保するようにしている。

```
cc -o mmap  mmap.c
eclair-mickey@eclairmickey-ThinkPad-T450s:~/Linux_prac/chapter5$ ./mmap
*** memory map before memory allocation ***
(略)
successed to allocate memory : address =0x0x7f5d42cb7000; size=0x6400000*** メモリマップが成功したことを示すメッセージ

*** emory map after memory allocation ***
(略)
7f5d42cb7000-7f5d490b7000 rw-p 00000000 00:00 0 終了アドレス
```
最後の行のアドレスの割当から、100MB程度のメモリが割り当てられていることがわかる。

# ファイルマップ
プロセスがファイルにアクセスする際、システムコールを使う時にファイルの領域を仮想メモリにメモリマップする機能がある。
この時に所定の方法でmmap()を呼び出すと、ファイルの内容をメモリに読み出すことが出来る。このメモリには通常のメモリと同様にアクセスすることが出来る。

```
cc -o filemap filemap.c
eclair-mickey@eclairmickey-ThinkPad-T450s:~/Linux_prac/chapter5$ ./filemap
*** memory map before mapping file***
(略)
*** successed to map file : address= 0x0x7f83c2029000; size=0x6400000 *** メモリマップ成功を表示

*** memory map after mapping file ***
(略)
7f83c2029000-7f83c8429000 rw-s 00000000 08:06 8917364                    /home/eclair-mickey/Linux_prac/chapter5/testfile testfileをマップしたこと表示
(略)

file contents before overwrite mapped region: hello testfileの内容を表示

*** overwritten mapped region with: HELLO testfileの更新後の内容を表示
```

